# Build a simplified image just for testing SQS connectivity
FROM golang:1.24-alpine

# Set working directory
WORKDIR /app

# Install build dependencies
RUN apk add --no-cache git gcc musl-dev ca-certificates curl

# Copy just the worker files needed for SQS testing
COPY apps/worker/internal/queue/sqsadapter.go ./sqsadapter.go
COPY apps/worker/cmd/sqs-test.go ./sqs-test.go

# AWS/SQS settings as environment variables
ENV USE_LOCALSTACK="true"
ENV AWS_ENDPOINT_URL="http://localstack:4566"
ENV AWS_REGION="us-east-1"
ENV SQS_QUEUE_NAME="tasks"
ENV AWS_ACCESS_KEY_ID="test"
ENV AWS_SECRET_ACCESS_KEY="test"

# Install AWS SDK
RUN go mod init sqstest && \
    go get github.com/aws/aws-sdk-go-v2/config && \
    go get github.com/aws/aws-sdk-go-v2/service/sqs && \
    go get github.com/aws/aws-sdk-go-v2/aws

# Compile and run the SQS test
CMD ["go", "run", "sqs-test.go"]
