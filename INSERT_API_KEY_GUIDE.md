# Guide: Inserting API Keys into Production Database

## Step 1: Generate an API Key

First, generate a new API key using the provided tool:

```bash
cd scripts
go run generate-api-key.go admin
```

This will output:
- The full API key (save this securely - it cannot be retrieved later)
- The key hash (for database storage)
- The key prefix
- An SQL insert statement

## Step 2: Insert into Database

### Option A: Using the Script

1. SSH into the production EC2 instance
2. Copy the `scripts/insert-production-api-key.sh` script to the instance
3. Set database environment variables:
   ```bash
   export DB_HOST=<your-rds-endpoint>
   export DB_NAME=<your-database-name>
   export DB_USER=<your-database-user>
   export DB_PASS=<your-database-password>
   ```
4. Run the script with your generated values:
   ```bash
   ./insert-production-api-key.sh \
     -k '<your-generated-api-key>' \
     -h '<your-generated-hash>' \
     -p '<your-key-prefix>' \
     -t admin \
     -n 'Your Key Name'
   ```

### Option B: Direct SQL

1. Connect to the PostgreSQL database
2. Use the SQL statement generated by the `generate-api-key.go` tool
3. Or customize this template:
   ```sql
   INSERT INTO mcp.api_keys (
       id, key_hash, key_prefix, tenant_id, user_id, name, key_type,
       scopes, is_active, rate_limit_requests, rate_limit_window_seconds,
       created_at, updated_at
   ) VALUES (
       uuid_generate_v4(), 
       '<YOUR_KEY_HASH>', 
       '<YOUR_KEY_PREFIX>', 
       '<YOUR_TENANT_ID>', 
       NULL, 
       '<YOUR_KEY_NAME>', 
       '<admin|gateway|agent|user>',
       ARRAY['<scope1>', '<scope2>', ...], 
       true, 
       <rate_limit>, 
       60,
       CURRENT_TIMESTAMP, 
       CURRENT_TIMESTAMP
   );
   ```

## Step 3: Update GitHub Secrets

After inserting the key into the database:

1. Go to GitHub repository settings
2. Navigate to Secrets and variables > Actions
3. Update or create the secret (e.g., `E2E_API_KEY`) with your generated API key

## Step 4: Verify

Verify the key was inserted correctly:

```sql
SELECT key_prefix, name, key_type, is_active, tenant_id 
FROM mcp.api_keys 
WHERE key_prefix = '<your-key-prefix>';
```

## Important Security Notes

- **Never commit API keys to source control**
- **Store API keys only in secure locations** (GitHub secrets, AWS Secrets Manager, etc.)
- **Use different API keys for different environments** (dev, staging, production)
- **Rotate API keys regularly**
- **The full API key is only visible when generated** - it cannot be retrieved from the database

## For E2E Tests

To fix the e2e tests:
1. Generate an admin API key
2. Insert it into the production database
3. Update the `E2E_API_KEY` GitHub secret
4. The CI/CD pipeline will use this key for authentication